MongoDB采用B-树索引


Mongodb 更新失败解决方案

现象：

WriteResult res = mongoTemplate.updateFirst(query, updateObj, "ServerToAgentReq_SMS");

获取res.getN()返回值时，发现偶尔情况下该返回值为0，表示该更新操作没有更新到任何数据。并且如果是多线程并发更新，失败几率大大提高。

官网表示不能保证更新操作的成功性....

方案：

一次失败后，另起线程多次重试。


### 面向服务的架构
1. 用户模块，订单模块，权限模块，流程模块
2. 把这些模块对外抽取，然后以服务的形式对外公开。
3. 我们把系统的功能模块打散，把各个模块功能组拼到一块可以形成一个系统。
4. 代码可以重用性更高；维护性更高；分流，可以提升系统的性能。

### 游标
1. 通俗的说，游标不是查询结果，而是查询的返回资料或者接口。
2. 通过这个接口，你可以逐条读取。就像php中的fopen打开文件，得到一个资源一样，通过资源，可以一行一行处理。

### 索引类型
1. 组合索引
2. 单键索引
3. 多值索引
4. 地址位置索引
5. 全文索引
6. TTL索引
7. 部分索引 ： 只取部分的数据建立索引
8. 哈希索引

### 组合索引
1. 组合索引的最佳方式ESR原则
精确 Equal : 匹配的字段放最前面
排序 Sort : 条件放中间
范围  Range ： 匹配的字段放最后s
同样适合ES，ER

### 其他索引技巧
1. 对BI / 报表专用节点单独创建索引
2. 该从节点priority设置为0
3. 关闭该从节点
4. 以单机模式启动
5. 添加索引（分析用）
6. 关闭该从节点，以副文集模式启动


### mongo数据库定位
1. 原则上Oracle和Mysql能做的事情，Mongodb都能做（包括ACID事务）
2. 优点：横向扩展能力，数据量或并发量增加时候架构可以自动扩展
3. 优点：灵活模型，适合迭代开发，数据模型多变场景
4. 优点：Json数据结构，适合微服务/REST API


### mongo功能的优势
1.  亿级以上的数据量
2. 灵活表结构
3. 高并发读
4. 高并发写
5. 跨地区集群
6. 分片集群
7. 地理位置查询
8. 聚合计算
9. 异构数据
10. 大宽表


### 基于场景选择Mongodb
1. 移动/小程序App
    场景特点：
        基于REST API / JSON
        快速迭代，数据结构变化频繁
        地理位置功能
        爆发增长可能性
        高可用
    MongoDB选型考量：
        文档模型可以支持不同的结构
        原生地理位置功能
        横向扩展能力支撑爆发增长
        复制集机制快速提供高可用
        摩拜单车/Keep/ADP
2. 电商
    场景特点：
        商品信息包罗万象
        商品的属性不同品类差异很大
        数据库模式设计困难
    MongoDB选型考量：
        文档模型可以集成不同商品属性
        可变模型适合迭代
        京东商品/小红书/GAP
3. 内容管理
    场景特点：
        内容数据多样，文本，图片，视频
        扩展困难，数据量爆发增长
    MongoDB选型考量：
        Json结构可以支持非结构化数据
        分片架构可以解决扩展问题
        Adobe AEM / Sitecore
4. 物联网
    场景特点：
        传感器的数据结构往往是半结构化
        传感器数量很大，采集频繁
        数据量很容易增长到数亿到百亿
    MongoDB选型考量：
        Json结构可以支持半结构化数据，使用分片能力支持海量数据
        Json数据更加容易和其他系统通过REST API 进行集成
        华为 / Bosch / Mindsphere
5. Saas应用
6. 主机分流
    场景特点：
        金融行业传统采用IBM或者小机
        传统瀑布开发模式流程长成本高
        结构不易改变，难于适应新需求
        根据某银行的统计，99%的数据库操作为读流量
        基于MIPS付费，读流量成本高
    MongoDB选型考量：
        使用实时同步机制，将数据同步出来到MongoDB
        使用MongoDB的高性能查询能力来支撑业务的读操作
        相比于关系模型数据库，更加容易迁入数据并构建成JSON模型进行API服务
7. 实时分析
    场景特点：
        流数据计算
        快速计算，秒级返回
    MongoDB选型考量：
        使用MongoDB缓存机制，可以利用内存计算加速
        使用MongoDB聚合框架，实现分析功能
        使用微分片脚骨的并发计算来大量缩减计算时间
8. 关系型迁移
    场景特点：
        基于Oracle / MySQL / SQLServer 的历史应用
        数据量增长或者使用者变多以后性能变慢
        分库分表需要应用配合
        结构死板，增加新需求复杂困难
    MongoDB选型考量：
        高性能高并发的数据库性能
        无需应用分库分表，集群自动解决扩容问题
        动态模型适合快速开发
        头条 / 网易 / 百度 / 东航 / 中国银行