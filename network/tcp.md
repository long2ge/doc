三次握手（为了验证双方接收、发送能力都正常）


在了解三次握手和四次挥手之前，先知道TCP报文内部包含了哪些东西。（自行百度报文）
![Image text](https://img-blog.csdn.net/20180717201939345?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)  



　　　　

字段	含义
序号 seq ：在包中的编号。表示发送的数据字节流，确保TCP传输有序，对每个字节编号
确认序号 ack ：发送方期待接收的下一序列号，接收成功后的数据字节序列号加 1。只有ACK=1时才有效。
ACK：确认序号的标志，ACK=1表示确认号有效，ACK=0表示报文不含确认序号信息
URG	紧急指针是否有效。为1，表示某一位需要被优先处理
ACK	确认号是否有效，一般置为1。
PSH	提示接收端应用程序立即从TCP缓冲区把数据读走。
RST	对方要求重新建立连接，复位。
SYN	连接请求序号标志，用于建立连接，SYN=1表示请求连接。请求建立连接，并在其序列号的字段进行序列号的初始值设定。建立连接，设置为1
FIN    	结束标志，用于释放连接，为1表示关闭本方数据流。希望断开连接。
窗口  现在允许对方发送的数据量。

2.1 三次握手过程
建立TCP连接时，需要客户端和服务器共发送3个包。

第一次：客户端发送初始序号x和syn=1请求标志

第二次：服务器发送请求标志syn，发送确认标志ACK，发送自己的序号seq=y，发送客户端的确认序号ack=x+1

第三次：客户端发送ACK确认号，发送自己的序号seq=x+1，发送对方的确认号ack=y+1

 2.2 三次握手过程分析：
第一次：客户端发送请求到服务器，服务器知道客户端发送，自己接收正常。SYN=1,seq=x
第二次：服务器发给客户端，客户端知道自己发送、接收正常，服务器接收、发送正常。ACK=1,ack=x+1,SYN=1,seq=y
第三次：客户端发给服务器：服务器知道客户端发送，接收正常，自己接收，发送也正常.seq=x+1,ACK=1,ack=y+1
上面分析过程可以看出，握手两次达不到让双方都得出自己、对方的接收、发送能力都正常的结论的。

四次挥手（为了关闭双方接收、发送能力）

 3.1 四次挥手过程
 
 https://img2018.cnblogs.com/blog/1344250/201904/1344250-20190402114137828-2119548758.png
 
第一次挥手：客户端发出释放FIN=1，自己序列号seq=u，进入FIN-WAIT-1状态
第二次挥手：服务器收到客户端的后，发出ACK=1确认标志和客户端的确认号ack=u+1，自己的序列号seq=v，进入CLOSE-WAIT状态
第三次挥手：客户端收到服务器确认结果后，进入FIN-WAIT-2状态。此时服务器发送释放FIN=1信号，确认标志ACK=1，确认序号ack=u+1，自己序号seq=w，服务器进入LAST-ACK（最后确认态）
第四次挥手：客户端收到回复后，发送确认ACK=1，ack=w+1，自己的seq=u+1，客户端进入TIME-WAIT（时间等待）。客户端经过2个最长报文段寿命后，客户端CLOSE；服务器收到确认后，立刻进入CLOSE状态。


3.2四次挥手过程分析
第一次：客户端请求断开FIN,seq=u
第二次：服务器确认客户端的断开请求ACK,ack=u+1,seq=v
第三次：服务器请求断开FIN,seq=w,ACK,ack=u+1
第四次：客户端确认服务器的断开ACK,ack=w+1,seq=u+1


https://img2018.cnblogs.com/blog/1344250/201904/1344250-20190402114059390-716421818.png


为什么客户端最后还要等待2MSL？
客户端需要保证最后一次发送的ACK报文到服务器，如果服务器未收到，可以请求客户端重发，这样客户端还有时间再发，重启2MSL计时。


应用层和传输层通过端口号识别应用程序。


半连接队列  存在第2次请求的队列。默认值128。建议调整大小为1024以上。
完成连接队列  完成3次握手的队列。默认值128。建议调整大小为1024以上。

TCP 超时重输  默认 3 <= x <= 15

TCP的三次握手是否都可以携带数据？
第一次和第二次是不可以携带数据的，但是第三次是可以携带数据的。

TCP初始化序列号不能设置为一个固定值，因为这样容易被攻击者猜出后续序列号，从而遭到攻击。
初始序列号作为 TCP 连接的一部分也需要在三次握手期间进行初始化，由于 TCP 连接通信的双方都需要获得初始序列号



IP / IGMP
ping是IGMP协议
mac地址是硬件实现，工作在数据链路层的。
IP地址工作在网络层和以上各层，是一种逻辑地址。

IP提供不可靠，无连接的数据报送服务。
发送TCP会排序，1-2-3-4发送。
发送方IP发送，收方IP接收是乱序。
收方TCP收到IP数据后会排序。

TCP的流量控制的每一端通过声明的窗口大小提供。
窗口大小为字节数，这个值是接收方控制发送方可以连续发送未经过确认的报文的数量。
发送滑动窗口一块块数据发送到接收方，接收方处理完后才继续发送。

发送端可以分成4个部分。


发送已确认  -  （发送未确认  -  允许发送但未发送）  -  不允许发送

括号（）内的就是滑动窗口

接收端将数据分成3个部分

已经ack  -  （已经接收但是没有ack）  -  未接收不能ack


括号（）内的就是滑动窗口


拥塞窗口是发送方使用的流量控制，而告知窗口则是接收方使用的流量控制。


窗口分为滑动窗口和拥塞窗口。
滑动窗口 -- 表征发送端和接收端的接收能力
拥塞窗口-- 表征中间设备的传输能力



参考博客 
https://www.cnblogs.com/jainszhang/p/10641728.html
https://blog.csdn.net/qq_38950316/article/details/81087809