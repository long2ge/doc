## Redis 和 Mysql 数据库数据如何保持一致性


#### 延时双删策略  

    redis设定合理的超时时间。具体步骤是：
    1. 先删除缓存
    2. 再写数据库
    3. 休眠500毫秒（根据具体情况来定。这里要考虑redis和数据库主从同步的耗时，还有并发读请求造成的缓存脏数据等。）
    4. 再次删除缓存。

上面的策略有2个问题

1 为什么要先删除缓存，是否多次一举。

    串行的时候，步骤2写完数据库后蹦了，那么缓存就不一致了，所以需要先删除缓存。
    
    并发的时候，删除缓存后，有可能马上又生成缓存，所以需要写数据库后，在删除缓存。
    
    综合来说，删缓存，写数据库，删缓存。第一步和第二步失败对数据没有影响。第三步有影响。所以要保证第三步的正确性。

2 步骤4删除失败的话，数据就不一致了。如何写完数据库后，再次删除缓存成功？

    方案一具体流程
    
    1. 更新数据库数据;
    
    2. 缓存因为种种问题删除失败;
    
    3. 将需要删除的key发送至消息队列(串行化mq 或者 key + version的分布式锁);
    
    4. 自己消费消息，获得需要删除的key;
    
    5. 继续重试删除操作，直到成功

### 异步更新缓存(基于订阅binlog的同步机制)

    MySQL binlog增量订阅消费+消息队列+增量数据更新到redis
    
    1. 读Redis：热数据基本都在Redis
    
    2. 写MySQL:增删改都是操作MySQL
    
    3. 更新Redis数据：MySQ的数据操作binlog，来更新到Redis
    
        3.1 数据操作主要分为两大块：
                一个是全量(将全部数据一次写入到redis)
                一个是增量（实时更新）
                这里说的是增量,指的是mysql的update、insert、delate变更数据。

        3.2 读取binlog后分析 ，利用消息队列,推送更新各台的redis缓存数据。
            这种机制很类似MySQL的主从备份机制，因为MySQL的主备也是通过binlog来实现的数据一致性。
            
        3.3 这里可以结合使用canal(阿里的一款开源框架)，通过该框架可以对MySQL的binlog进行订阅，
            而canal正是模仿了mysql的slave数据库的备份请求，使得Redis的数据更新达到了相同的效果。
            当然，这里的消息推送工具你也可以采用别的第三方：kafka、rabbitMQ等来实现推送更新Redis